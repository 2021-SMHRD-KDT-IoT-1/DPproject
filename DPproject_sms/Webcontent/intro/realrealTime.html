<!DOCTYPE html>
<html>
<head>
<title>실시간 화재 감시</title>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="../css/realtime.css" rel="stylesheet" type="text/css">

<!-- Load Leaflet from CDN -->
<link rel="stylesheet"
	href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
	integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
	crossorigin="" />
<script src="https://unpkg.com/lea\flet@1.5.1/dist/leaflet.js"
	integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
	crossorigin=""></script>

<!-- Personal style and script file links -->
<!--     <link rel="stylesheet" href="css/style.css">
      <script src="js/script.js" type="text/javascript" defer></script>-->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
<script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
<script type="text/javascript" src="../assets/js/leaflet.ajax.min.js"></script>


<style>
#header{
	box-sizing: border-box;
	height: 15vh;
	padding : 15px 30px;	
}

#section {
	box-sizing: border-box;
	width: 18vw;
	height: 80vh;
	float: left;
}

#main{
	box-sizing: border-box;
	width: 80vw;
	height: 80vh;
	float: right;
	padding : 20px 130px;
}

#map {
	box-sizing: border-box;
	width : 1200px;
	height : 65vh;
	margin-top: 10px;
}

#escape {
	height: 5vh;
	box-sizing: border-box;
	float: center;
}
</style>
</head>
<body>
		<div id="header" align="left">
			<img src="../images/logo.png" width=200px>
		</div>
		
		<div id="section">
			<ul>
				<li><a>스마트인재캠퍼스</a></li>
					<ul>
						<li><a>1F</a></li>
						<li><a>2F</a></li>
						<li><a>3F</a></li>
					</ul>
				<li><a>스마트인재개발원</a></li>
					<ul>
						<li><a>1F</a></li>
						<li><a>2F</a></li>
						<li><a>3F</a></li>
					</ul>
			</ul>
		</div>



<div id="main">

			<span id="escape">
				<button id="normal">피난안내도</button>
				<button id="btnb1">대피로1</button>
				<button id="btnb2">대피로2</button>
				<button id="btnb3">대피로3</button>
				<button id="btnb4">대피로4</button>
			</span>

		<div id="map">
			<script>
//----------------------------------지도 기본 세팅 --------------------------------------------     
    var map = L.map('map', {crs: L.CRS.Simple});
    var bounds = [[0,0], [600,1000]]; // Set the image resolution as the boundary
    L.imageOverlay("../images/temp/final.png", bounds).addTo(map); // Set the background image
  	map.fitBounds(bounds); // Set an area
//---------------------------------------------------------------------------------------    



//----------------------------------아이콘 변경 기능------------------------------------------
  //나중에 써먹을라고(그때 미희샘이 아두이노할 때 트루 펄스 이걸로 막 조건문 제어하는거임)  
    var a = true;
  //파폭 아이콘 선언 
    var firefoxIcon = L.icon({
        iconUrl: 'http://joshuafrazier.info/images/firefox.svg',
        iconSize: [38, 95], // size of the icon
        popupAnchor: [0,-15]
        });

     //크롬 아이콘 선언   
    var chromeIcon = L.icon({
        iconUrl: 'https://www.logo.wine/a/logo/Google_Chrome/Google_Chrome-Logo.wine.svg',
        iconSize: [42, 99], // size of the icon
        popupAnchor: [0,-15]
        }); 
     
    L.circle([390, 575], {color: 'green',radius: 20}).addTo(map)//(30,50)좌표에 원 생성
    .bindTooltip("A", {permanent: true, direction: 'center'}).openTooltip();
    // .on("click", circleClick);// .on("click", 사용자정의함수) 형식같은데, 클릭시 사용자정의함수를 실행시키라는 함수임 
     
    
    L.circle([300, 275], {color: 'green',radius: 20}).addTo(map)
    .bindTooltip("B", {permanent: true, direction: 'center'}).openTooltip();
    
    

    function circleClick(e) {// e는 그 클릭된 대상같음
        var clickedCircle = e.target; //클릭된 대상을 변수에 저장햇음
        clickedCircle.remove(); // 원 삭제 기능
        L.marker([390, 575], {icon: firefoxIcon}).addTo(map).on("click", markerClick);
        // 원을 삭제하고 아이콘을 그 위치에 생성한 거임 (근데 리플렛은 아이콘생성할려면 리플렛 고유의 "마커"라는 
        // 개체를 생성하고 거기에 붙여야 하는 거같음 그래서 마커만들고 거기에 아이콘 붙이고 그것을 맵에다 붙이고 그것에 
        // 클릭시 실행할 사용자정의함수를 붙였음 )
    }
    
    function markerClick(e) {
        
        var clickedmarker = e.target;    
        if(a) //현재 제일 위에서 전역변수로 a를 트루라고 해놓았음 따라서 처음 마커클릭하면 여기가 실행됨
        {clickedmarker.setIcon(chromeIcon); //처음 마커클릭하면 크롬아이콘으로 바꿈
            a = false; //그리고 상태(=a)를 펄스라고 바꿈 (다음 클릭시에는 다른 기능을 작동시키게끔)
        }
        
        else{ // 두번째 클릭때는 상태(=a)가 펄스인 상태이기때문에 여기가 실행됨, 다시 원으로 돌아가게 함
            clickedmarker.remove();
            L.circle([400, 300], {color: 'green',radius: 20}).addTo(map)//(30,50)좌표에 원 생성
        .on("click", circleClick);
        a=true;
        
        }
    }
    
      //---------------------------------------------------------------------------------------  

// -----------------------------------리플렛 용 Ajax통신하는 기능----------------------------------    
    function popUp(feature, layer) {
        layer.bindTooltip(
        		"가스 : " + feature.properties.gas + "  " +
        		"불 : " + feature.properties.fire + "   "  +
        		"온도 : " + feature.properties.temp , {permanent: true, direction: 'center'}).openTooltip();
        }   
      
     function popUp2(feature, layer) {
        layer.bindTooltip(
        		"가스 : " + feature2.properties2.gas2 + "  " +
        		"불 : " + feature2.properties2.fire2 + "   "  +
        		"온도 : " + feature2.properties2.temp2 , {permanent: true, direction: 'center'}).openTooltip();
        }   
      
/*    function changeColor(feature,layer) {
       if (feature.properties.gas < 30)
    	
    	
    	
    a1 = L.geoJSON(feature, {
            style: myStyle1
            }).addTo(map);   
    }  
    
    else if  (feature.properties.gas < 60)
    	
    	
    	
    	a1 = L.geoJSON(feature, {
            style: myStyle2
            }).addTo(map);   
    }  
      
	 else if  (feature.properties.gas < 90)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle3
            }).addTo(map);   
    }  
    
	 else if  (feature.properties.gas < 120)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle4
            }).addTo(map);   
    }  
    
 	else if  (feature.properties.gas < 150)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle5
            }).addTo(map);   
    }  
    
 	else if  (feature.properties.gas < 180)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle6
            }).addTo(map);   
    }  
    
 	else if  (feature.properties.gas < 210)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle7
            }).addTo(map);   
    }  
    
 else if  (feature.properties.gas < 240)
    	
    	
    	
    	a1 = L.geoJSON(roomcounter, {
            style: myStyle8
            }).addTo(map);   
    }  
     
    }  */
    
    setInterval(function(){
    	new L.GeoJSON.AJAX("../SensorServiceCon?num=1", {onEachFeature:popUp}).addTo(map)}, 2000);
//       new L.GeoJSON.AJAX("MonitorServiceCon", {onEachFeature:changeColor}).addTo(map)}, 2000);
//----------------------------------------------------------------------------------------  





    
// -----------------------------------화면에 구역 표시하는 기능-----------------------------------	
	//GeoJson이라는 건데 제이슨인데 리플렛용 제이슨 같음 이렇게 제이슨을 선언하면 바로 맵에 그 정보가 나타남
    var roomcounter = {
    "type": "Feature",
    "properties": {
        "name": "counter",
        "flame": "",   //이 구역은 이러한 정보를 담고있다는 것임
        "gas": "",
        "temp": "",
    },
    "geometry": { // 좌표정보 적는 곳
        "type": "Polygon", //만약 여기를 직선으로 선언하면 아래 좌표를  [40, 180],   [40, 340] 두개만 선언하면 됨
                            //지금은 다각형으로 선언해서 좌표 4개를 찍어서 사각형으로 만들었음
        "coordinates": [[
        [70, 110],
        [70, 540],    
        [540, 540],
        [540, 110],         
        ]]
    }
};

 	     var roomcounter2 = {
    	    "type": "Feature",
    	    "properties": {
    	        "name": "counter2",
    	        "flame": "",   //이 구역은 이러한 정보를 담고있다는 것임
    	        "gas": "",
    	        "temp": "",
    	    },
    	    "geometry": { // 좌표정보 적는 곳
    	        "type": "Polygon", //만약 여기를 직선으로 선언하면 아래 좌표를  [40, 180],   [40, 340] 두개만 선언하면 됨
    	                            //지금은 다각형으로 선언해서 좌표 4개를 찍어서 사각형으로 만들었음
    	        "coordinates": [[
    	        [350, 160],
    	        [350, 540],    
    	        [730, 540],
    	        [730, 160],         
    	        ]]
    	    }
    	};  
    //GepJson 스타일 바꿀려고 스타일 유형을 미리 지정해놓음(빨주노초파남보)
     
      var myStyle1 = {
           "color": "#FFEDA0",
           "weight": 5,
           "opacity": 0.65
       };
           
           
              var myStyle2 = {
                  "color": "#FED976",
                  "weight": 5,
                  "opacity": 0.65
              };
           
           var myStyle3 = {
                  "color": "#FEB24C",
                  "weight": 5,
                  "opacity": 0.65
              };
           
           var myStyle4 = {
                  "color": "#FD8D3C",
                  "weight": 5,
                  "opacity": 0.65
              };
           
           var myStyle5 = {
                  "color": "#FC4E2A",
                  "weight": 5,
                  "opacity": 0.65
              };
           
           var myStyle6 = {
                  "color": " #E31A1C",
                  "weight": 5,
                  "opacity": 0.65
              };
           
           var myStyle7 = {
                  "color": "#BD0026",
                  "weight": 5,
                  "opacity": 0.65
              };

              var myStyle8 = {
                  "color": "#800026",
                  "weight": 5,
                  "opacity": 0.65
              };
              
              var myStyle9 = {
                      "color": "#87CEEB",
                      "weight": 5,
                      "opacity": 0.65
                  };
    
    //-------------------------------------------------------------------------------------- 
    </script>
		</div>

<script>

document.getElementById("normal").addEventListener("click", nomal);
function nomal(){
     var b = L.imageOverlay("../images/temp/final.png", bounds).addTo(map);
}

document.getElementById("btnb1").addEventListener("click", btnclk5);
function btnclk5(){
     var b = L.imageOverlay("../images/temp/exit1.png", bounds).addTo(map);
}

document.getElementById("btnb2").addEventListener("click", btnclk6);
function btnclk6(){
     var b = L.imageOverlay("../images/temp/exit2.png", bounds).addTo(map);
}

document.getElementById("btnb3").addEventListener("click", btnclk7);
function btnclk7(){
     var b = L.imageOverlay("../images/temp/exit3.png", bounds).addTo(map);
}

document.getElementById("btnb4").addEventListener("click", btnclk8);
function btnclk8(){
     var b = L.imageOverlay("../images/temp/exit4.png", bounds).addTo(map);
}



//-------------------------------화재난 곳의 온도와 연기의 정도에 따라 색의 농도로 표현하는 기능----------------------------------------------------------------

setInterval(function(){
    $.ajax({
        type: "GET",
        url: "../SensorServiceCon?num=1",
        dataType: "json", 
        success: function(response) {
     	   L.geoJson(roomcounter, {style: myStyle1}).addTo(map);
     	  L.geoJson(roomcounter2, {style: myStyle9}).addTo(map);   	  
        }
     })
    }, 2000);

//---------------------------------------------------------------------------------------------------------------------------------------------   



//--------------------------------------------------불이 난 곳을 피해서 대피로를 자동으로 설정해주는 기능---------------------------------------------------
setTimeout( function(){L.imageOverlay("../images/temp/exit2.png", bounds).addTo(map)}, 9000);

//--------------------------------------------------\----------------------------------------------------------------------------------------------

</script>

</div>

</body>
</html>